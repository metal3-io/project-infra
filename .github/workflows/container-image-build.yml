name: build-images action template
permissions: {}

on:
  workflow_call:
    inputs:
      ref:
        required: false
        description: "Git reference of the workflow's trigger"
        type: string
      image-build-args:
        required: false
        description: "Arguments to pass to the image build process"
        type: string
      image-name:
        required: true
        description: "Name of the image to build"
        type: string
      image-tag:
        required: false
        description: "Override autogenerated image tag"
        type: string
        default: ""
      dockerfile-directory:
        required: false
        description: "The directory where the dockerfile locates, as relative to the repo root"
        type: string
        default: .
      pushImage:
        required: false
        description: "Whether to push the image afterwards"
        type: boolean
        default: true
      multiPlatform:
        required: false
        description: "Enable multiPlatform builds for the container image"
        type: boolean
        default: false
      platform:
        required: false
        description: "Architecture platforms for the image build (linux/amd64,linux/arm64, etc.)"
        type: string
        default: ""
      artifact-name:
        required: false
        description: "Name of an artifact to be downloaded. Setting this will set the downloaded artifact direcory as image building base."
        type: string
        default: ""
      generate-sbom:
        required: false
        description: "Generate SBOM for the container image"
        type: boolean
        default: false
      sign-image:
        required: false
        description: "Sign the container image with Cosign (keyless)"
        type: boolean
        default: false
    secrets:
      QUAY_USERNAME:
        required: true
      QUAY_PASSWORD:
        required: true
      SLACK_WEBHOOK:
        required: true
    outputs:
      image-digest:
        description: "The digest of the built image"
        value: ${{ jobs.job.outputs.digest }}
      sbom-artifact:
        description: "Name of the uploaded SBOM artifact (if generated)"
        value: ${{ jobs.job.outputs.sbom-artifact }}

jobs:
  job:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'metal3-io'

    permissions:
      contents: read
      id-token: write  # Required for Sigstore keyless attestation

    outputs:
      digest: ${{ steps.get-digest.outputs.digest }}
      sbom-artifact: ${{ inputs.generate-sbom && inputs.pushImage && format('{0}-sbom', inputs.image-name) || '' }}

    steps:
    - name: Set GITHUB_REF and GITHUB_REFNAME to the inputs' ref, or default to github's ref
      id: set_ref
      run: |
        REF="${{ inputs.ref || github.ref }}"
        echo "Using INPUT REF: ${REF}"
        REF_NAME="${REF#refs/heads/}"
        REF_NAME="${REF_NAME#refs/tags/}"
        echo "GITHUB_REF=${REF}" >> "${GITHUB_ENV}"
        echo "GITHUB_REFNAME=${REF_NAME}" >> "${GITHUB_ENV}"
        echo "Using GITHUB REFNAME: ${REF_NAME}"

    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      with:
        ref: ${{ env.GITHUB_REF }}

    - name: Set GITHUB_REFSHA to sha of the ref
      id: set_refsha
      run: |
        REF_SHA=$(git rev-parse HEAD)
        echo "GITHUB_REFSHA=${REF_SHA}" >> "${GITHUB_ENV}"

    - name: Get current date
      id: date
      run: echo "current_date=$(date +'%Y-%m-%d')" >> "${GITHUB_OUTPUT}"

    - name: Get image tags and set version label
      id: image_tags
      run: |
        BASE_TAG=$(echo "${{ env.GITHUB_REFNAME }}" | sed 's/\//_/')
        IMAGE_TAGS="${BASE_TAG}, ${BASE_TAG}_${{ steps.date.outputs.current_date }}_${{ env.GITHUB_REFSHA }}"

        if [[ -n "${{ inputs.image-tag }}" ]]; then
          IMAGE_TAGS="${{ inputs.image-tag }}"
          IMAGE_VERSION="${{ inputs.image-tag }}"
        elif [[ "${{ env.GITHUB_REF }}" == "refs/heads/main" ]]; then
          IMAGE_TAGS="${IMAGE_TAGS}, latest"
          IMAGE_VERSION="latest"
        else
          IMAGE_VERSION="${{ env.GITHUB_REFNAME }}"
        fi

        echo "IMAGE_TAGS=${IMAGE_TAGS}" >> "${GITHUB_ENV}"
        echo "IMAGE_VERSION=${IMAGE_VERSION}" >> "${GITHUB_ENV}"

    - name: Download artifact
      id: download-artifact
      if: ${{ inputs.artifact-name }} != ""
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
      with:
        name: ${{ inputs.artifact-name }}
        path: /tmp/build-${{ inputs.image-name }}

    - name: Build ${{ inputs.image-name }} image
      uses: mr-smithers-excellent/docker-build-push@19d2beefef6bcdc202195fdcb9deb79a4fab5c1f # v6.8
      with:
        image: metal3-io/${{ inputs.image-name }}
        tags: ${{ env.IMAGE_TAGS }}
        directory: ${{ inputs.artifact-name != '' && steps.download-artifact.outputs.download-path || inputs.dockerfile-directory }}
        dockerfile: ${{ inputs.artifact-name != '' && steps.download-artifact.outputs.download-path || inputs.dockerfile-directory }}/Dockerfile
        buildArgs: ${{ inputs.image-build-args || '' }}
        labels: |
          org.opencontainers.image.version=${{ env.IMAGE_VERSION }}
        registry: quay.io
        username: ${{ secrets.QUAY_USERNAME }}
        password: ${{ secrets.QUAY_PASSWORD }}
        pushImage: ${{ inputs.pushImage }}
        multiPlatform: ${{ inputs.multiPlatform }}
        platform: ${{ inputs.platform }}

    - name: Get image digest
      id: get-digest
      if: ${{ inputs.pushImage }}
      run: |
        FIRST_TAG=$(echo "${{ env.IMAGE_TAGS }}" | cut -d',' -f1 | tr -d ' ')
        DIGEST=$(docker buildx imagetools inspect "quay.io/metal3-io/${{ inputs.image-name }}:${FIRST_TAG}" --format "{{json .Manifest.Digest}}" | tr -d '"')
        echo "digest=${DIGEST}" >> "${GITHUB_OUTPUT}"
        echo "IMAGE_REF=quay.io/metal3-io/${{ inputs.image-name }}@${DIGEST}" >> "${GITHUB_ENV}"
        echo "Image digest: ${DIGEST}"

    # === SBOM Generation (when enabled) ===
    - name: Set up Go
      if: ${{ inputs.generate-sbom && inputs.pushImage }}
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version: '1.24'

    - name: Install bom tool
      if: ${{ inputs.generate-sbom && inputs.pushImage }}
      run: go install sigs.k8s.io/bom/cmd/bom@1ab6284ac5e118267414f2ac3874bb08a701e9ad # v0.7.1

    - name: Generate Image SBOM
      if: ${{ inputs.generate-sbom && inputs.pushImage }}
      run: |
        bom generate \
          -i "${IMAGE_REF}" \
          --output ${{ inputs.image-name }}-sbom.spdx.json \
          --format json \
          --name "${{ inputs.image-name }}-${{ env.IMAGE_VERSION }}"
        echo "Image SBOM generated for ${IMAGE_REF}"
        echo "Package count: $(jq '.packages | length' ${{ inputs.image-name }}-sbom.spdx.json)"

    - name: Install Cosign
      if: ${{ (inputs.generate-sbom || inputs.sign-image) && inputs.pushImage }}
      uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

    - name: Sign container image
      if: ${{ inputs.sign-image && inputs.pushImage }}
      run: |
        cosign sign --yes "${IMAGE_REF}"
        echo "Container image signed: ${IMAGE_REF}"

    - name: Attest SBOM to image
      if: ${{ inputs.generate-sbom && inputs.pushImage }}
      run: |
        cosign attest --yes \
          --predicate ${{ inputs.image-name }}-sbom.spdx.json \
          --type spdxjson \
          "${IMAGE_REF}"
        echo "SBOM attestation attached to: ${IMAGE_REF}"

    - name: Upload SBOM artifact
      id: upload-sbom
      if: ${{ inputs.generate-sbom && inputs.pushImage }}
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: ${{ inputs.image-name }}-sbom
        path: ${{ inputs.image-name }}-sbom.spdx.json

    - name: Slack Notification on Failure
      if: ${{ failure() }}
      uses: rtCamp/action-slack-notify@e31e87e03dd19038e411e38ae27cbad084a90661 # 2.3.3
      env:
        SLACK_TITLE: "GitHub Action Failed in ${{ github.repository }}"
        SLACK_COLOR: "#FF0000"
        SLACK_MESSAGE: "The GitHub Action workflow failed for ${{ inputs.image-name }} image build."
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_CHANNEL: metal3-github-actions-notify
        SLACK_USERNAME: metal3-github-actions-notify
